# ユーザ管理スクリプト

SINETStreamコンフィグサーバのユーザを管理するためのスクリプトについて記します。

## 1. 概要

コンフィグサーバのWebUIを利用するには、ローカルユーザ認証もしくは学認連携認証によるログインを行います。ローカルユーザ認証で利用するには、事前にコンフィグサーバにユーザを登録することが必要となります。また学認連携認証を利用する場合はログイン時に連携するIdPから得た情報でコンフィグサーバが自動的にユーザ登録を行います。登録されたユーザの利用を停止する場合、コンフィグサーバからユーザを削除する必要があります。これらのユーザ管理操作を行うためのユーティリティコマンドを提供します。

ここで提供するユーザ管理ツールを利用するにはコンフィグサーバのシステム管理者権限が必要となります。コンフィグサーバのセットアップ時にデフォルトで作成されるシステム管理者の情報を次表に示します。

|ユーザ名|パスワード|
|---|---|
|admin|admin-password|

## 2. インストール

### 2.1. 前提条件

Python 3.7以上のPython実行環境を前提とします。

### 2.2. インストール手順

パッケージを作成します。このディレクトリで以下のコマンドを実行してください。

```console
$ python setup.py sdist
```

上記のコマンドが成功すると `./dist/` にソースパッケージが作成されています。

```console
$ ls dist
sinetstream.cfgsrv-0.1.0.tar.gz

```

作成したパッケージをインストールします。

```console
$ pip install dist/sinetstream.cfgsrv-0.1.0.tar.gz --user
```

インストールが成功すると `user-mgmt` コマンドが利用できるようになります。

```console
$ user-mgmt --help
usage: user-mgmt [-h] -s SERVER -u USER [-p PASSWORD]  
                 {import,remove,export,admin} ...      

positional arguments:
  {import,remove,export,admin}

optional arguments:
  -h, --help            show this help message and exit
  -s SERVER, --server SERVER
  -u USER, --user USER
  -p PASSWORD, --password PASSWORD
```

## 3. 使用方法

### 3.1. 共通オプション

```
user-mgmt -s SERVER -u USER [-p PASSWORD] {sub command} ...
```

共通オプションでは、操作対象となるコンフィグサーバに接続するためパラメータを指定します。共通オプションの後に続く`sub command`以降の指定で具体的な操作に関するパラメータを指定します。各操作に関する指定方法については次節以降で説明します。

共通オプションで指定するパラメータを以下に示します。

* `-s SERVER`, `--server SERVER`
    - 対象となるコンフィグサーバのURLを指定します
* `-u USER`, `--user USER`
    - システム管理者のユーザ名を指定します
* `-p PASSWORD`, `--password PASSWORD`
    - システム管理者のパスワードを指定します
    - このオプションを指定しない場合、標準入力からのパスワード入力が要求されます

サブコマンドとして指定するコマンド名を以下に示します。
* `import`
    - CSVファイルをコンフィグサーバにインポートしてユーザ登録、更新を行います
* `remove`
    - CSVファイルに指定されているユーザの削除を行います
* `export`
    - コンフィグサーバに登録されているユーザの情報をCSVファイルにエクスポートします
* `admin`
    - 登録されているユーザに対してシステム管理者権限の付与、除去を行います

### 3.2. ユーザ登録、更新（CSVファイルのインポート）

```
... import -c CSV_FILE [-H]
```

ユーザ情報を記録したCSVファイルをコンフィグサーバにインポートし、ユーザの登録、更新処理を行います。CSVファイルのユーザ情報がコンフィグサーバに登録されていない場合は新規登録処理を実行し、既に登録されている場合は更新処理を実行します。新規登録の場合はローカルユーザとして登録を行います。

CSVファイルは「ユーザ名」「パスワード」「メールアドレス」「表示名」の４つの項目を１行に記したものとなります。５カラム目以降の値は無視されます。CSVファイルの例を以下に示します。

```csv
name,password,email,displayName
user01,pass01,user01@example.org,USER-01
user02,pass02,user02@example.org,USER-02
```

CSVファイルの先頭行はヘッダーとみなし処理対象から除外します。また更新処理の場合CSVファイルで空欄となっている項目は変更を行わずに登録されている内容を保持します。新規登録時はユーザ名、パスワードが、また更新時はユーザ名が必須項目となります。必須項目が空欄の場合はエラーとなります。

コマンドラインで指定するパラメータを以下に示します。

* `-c CSV_FILE`, `--csv CSV_FILE`
    - インポートするCSVファイルを指定します
* `-H`, `--no-header`
    - CSVファイルの１行目をヘッダーとして扱わずに全ての行をユーザ情報として処理します

実行例を以下に示します。

```console
$ user-mgmt -s https://sscfg.example.org -u admin import -c users.csv
```

パスワード入力プロンプトに対してシステム管理者のパスワードを入力するとCSVファイルのインポートが実行され、ユーザ登録、更新が行われます。

### 3.3. ユーザ削除

```
... remove -c CSV_FILE [-H]
```

CSVファイルに記録されているユーザをコンフィグサーバから削除します。

CSVファイルは１カラム目に削除対象のユーザ名を記したものとなります。２カラム目以降の値は無視されます。また先頭行はヘッダーとみなし処理対象から除外します。

コンフィグサーバに接続するために共通オプションの `-u USER`で指定したユーザはCSVファイルに記述があっても削除対象から除外されます。

コマンドラインで指定するパラメータを以下に示します。

* `-c CSV_FILE`, `--csv CSV_FILE`
    - CSVファイルを指定します
* `-H`, `--no-header`
    - CSVファイルの１行目をヘッダーとして扱わずに全ての行をユーザ情報として処理します

実行例を以下に示します。

```console
$ user-mgmt -s https://sscfg.example.org -u admin remove -c users.csv
```


### 3.4. 登録ユーザの確認（CSVファイルへのエクスポート）

```
... export -c CSV_FILE [-H] [-A]
```

コンフィグサーバに登録されているユーザをCSVファイルにエクスポートします。デフォルトではローカルユーザに関する情報のみをCSVファイルにエクスポートします。学認連携のユーザを含む全ての情報をエクスポートする場合は、コマンドライン引数`-A`を指定してください。

CSVファイルは「ユーザ名」「パスワード」「メールアドレス」「表示名」「システム管理者フラグ」の５つの項目を１行に記したものとなります。ただしパスワード欄は常に空欄でエクスポートされます。エクスポートされたCSVファイルの例を以下に示します。

```csv
name,password,email,displayName,systemAdmin
admin,,,True
user01,,user01@example.org,USER-01,False
user02,,user02@example.org,USER-02,False
```

CSVファイルの先頭行はヘッダーとなります。

コマンドラインで指定するパラメータを以下に示します。

* `-c CSV_FILE`, `--csv CSV_FILE`
    - CSVファイルを指定します
* `-H`, `--no-header`
    - １行目のヘッダーがないCSVファイルをエクスポートします
* `-A`, `--all`
    - ローカルユーザだけでなく学認連携のユーザに関する情報もエクスポートします

実行例を以下に示します。

```console
$ user-mgmt -s https://sscfg.example.org -u admin export -c users.csv
```

### 3.5. システム管理者権限の変更

```
... admin -U TARGET_USER (-A | -R)   
```

登録されているユーザに対してシステム管理者権限の付与、除去を行います。コンフィグサーバに接続するために共通オプションの `-u USER`で指定したユーザのシステム管理者権限を変更することは出来ません。

コマンドラインで指定するパラメータを以下に示します。

* `-U TARGET_USER`, `--target-user TARGET_USER`
    - システム管理者権限を変更する対象となるユーザ名を指定します
* `-A`, `--add`
    - 指定されたユーザにシステム管理者権限を付与します
* `-R`, `--remove`
    - 指定されたユーザからシステム管理者権限を除去します

実行例を以下に示します。

```console
$ user-mgmt -s https://sscfg.example.org -u admin admin -U user01 -A
```

ローカルユーザに対してのみシステム管理者権限を付与することが出来ます。